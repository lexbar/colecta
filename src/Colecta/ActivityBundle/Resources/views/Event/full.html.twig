{% extends '::frontend.html.twig' %}

{% block events 'active' %}

{% block javascripts %}    
    <script>
    var xhr;
    var searchagain = false;
    
    function showResults()
    {
        if($('#userSearch').val().length < 2) {
            hideResults();
            return;
        }
        
        $('#destinationLoading').removeClass('hidden');
        
        if(xhr && xhr.readyState != 4) {
            searchagain = true;
        } else {        
            
            xhr = $.ajax({
                url: '{{ path('ColectaAjaxUserSearch') }}?search='+$('#userSearch').val(),
                success: function(json) {
                    $('#userResults').html('');
                    $('#userResults').css('display','none');
                    for(var i = 0; i < json.length; i++) {
                        $('#userResults').append('<li id="userResult'+(i + 1)+'"><a tabindex="-1" href="#'+json[i].id+'" onClick="$(\'#userSearch\').val(\''+json[i].name+'\');hideResults();highlightUpdateBtn();return false;"> '+json[i].name+'</a></li>');
                    } 
                    if(json.length) { $('#userResults').css('display','block'); }
                    //$('#searchButton').removeAttr("disabled"); 
                },
                cache: false
            }).done(function() { 
                if(searchagain) 
                {
                    searchagain = false;
                    showResults();
                }
                else
                {
                    $('#destinationLoading').addClass('hidden');
                }
            });
        }
    }
    
    //Key up
    $('#userSearch').keyup(function(e){
        if($('#userResults li').length) {
            var current = $('#userResults li.active');
            var currentN = 0;
            if(current.length) {
                currentN = parseInt(current.attr('id').substring(10));
            } 
            
            if(e.keyCode == 40){
                if($('#userResult'+(currentN + 1)).length) {
                    $('#userResult'+(currentN)).removeClass('active');
                    $('#userResult'+(currentN + 1)).addClass('active');
                    return;
                }
                return;
            } else if(e.keyCode == 38){
                if($('#userResult'+(currentN - 1)).length) {
                    $('#userResult'+(currentN)).removeClass('active');
                    $('#userResult'+(currentN - 1)).addClass('active');
                    return;
                }
                return;
            } else if(e.keyCode == 13){
                if($('#userResult'+(currentN)).length) {
                    $('#userResult'+(currentN)+' a').click();
                    return;
                }
                return;
            }
        }
        
        showResults();
    });
    
    function hideResults() 
    {
        $('#userResults').html('');
        $('#userResults').css('display','none');
    }
    
    function highlightUpdateBtn() 
    {
        $('#updateBtn').addClass('btn-primary');
    }
    
    </script>
{% endblock %}

{% block article %}
<div class="event full" itemscope itemtype="http://schema.org/Event">
    {% include 'ColectaItemBundle:Default:itemheader.html.twig' with { 'item': item } only %}
    
    <div class="itemcontent">
        <div class="unity">
            <div class="date" itemprop="startDate">
                <span class="weekday">{{ item.dateini | date('l') | replace ({
                    'Monday':'Lunes',
                    'Tuesday':'Martes',
                    'Wednesday':'Miércoles',
                    'Thursday':'Jueves',
                    'Friday':'Viernes',
                    'Saturday':'Sábado',
                    'Sunday':'Domingo'
                }) }}</span>
                <span class="monthday">{{ item.dateini | date('d') }}</span> 
                <span class="month">{% set month = item.dateini | date('n') | replace({
                    '1':'Enero',
                    '2':'Febrero',
                    '3':'Marzo',
                    '4':'Abril',
                    '5':'Mayo',
                    '6':'Junio',
                    '7':'Julio',
                    '8':'Agosto',
                    '9':'Septiembre',
                    '10':'Octubre',
                    '11':'Noviembre',
                    '12':'Diciembre'
                }) %}{% if item.dateini | date('Y') == 'today' | date('Y') %}{{month}}{% else %}{{ month | slice(0,3) ~ ' ' ~ item.dateini | date('Y') }}{% endif %}</span>
                <span class="hour">{{ item.dateini | date('H:i') }}</span>
            </div>
            
            <h2 itemprop="name">{{ item.name }}</h2>
            <p itemprop="description">{{ item.description | usercontent | raw | nl2br }}</p>
        </div>
    
    {% include 'ColectaActivityBundle:Default:properties.html.twig' with { item: item } only %}
    
    </div>
    
    
    {######## ASSISTANCES ########}
    
    {% set canedit = item.author == app.user %}
    {% set haspassed = item.dateini | date('U') < 'now' | date('U') %}
    
    {% if canedit %}<form action="{{ path('ColectaEventUpdateAsist', {'slug':item.slug}) }}" method="POST" onSubmit="if($('#userResults .active a').length) return false; else $('#updateBtnLoading').addClass('icon-refresh icon-spin')">{% endif %}
    
    <div class="assistances">
    <h2>{% if haspassed %}Han asistido{% else %}Van a asistir{% endif %}</h2>
        
    <ul class="unstyled">    
    {% for assistance in item.assistances %}
    
        <li class="{% if loop.index is odd %}odd{% else %}even{% endif %}">
            <a class="username" href="{{ path('userProfile', { 'id': assistance.user.id }) }}" itemprop="attendee">
            <img width="20" height="20" src="{% if assistance.user.avatar %}{{ path('userAvatar',{'uid':assistance.user.id,'width':40,'height':40}) }}{% else %}/img/unknown.gif{% endif %}"> {{assistance.user.name}}
            </a> 
        
            {% if haspassed %}
                {% if canedit %}
                    <span class="pull-right">
                        <input type="text" class="span1" name="user{{assistance.user.id}}km" value="{% if assistance.km <= 0 and not assistance.confirmed %}{{ item.distance }}{% else %}{{ assistance.km }}{% endif %}" onKeyUp="highlightUpdateBtn()"> km | 
                        <label for="user{{assistance.user.id}}confirmed">confirmar</label> <input onClick="highlightUpdateBtn()" type="checkbox" {% if assistance.confirmed %}checked{%endif%} name="user{{assistance.user.id}}confirmed" id="user{{assistance.user.id}}confirmed">
                    </span>
                {% elseif assistance.confirmed %}
                    <span class="pull-right">{{ assistance.km }} km <i class="icon-ok"></i></span>
                {% endif %}
            {% endif %}
        </li>
        
    {% else %}
        <li><em>Ninguna asistencia confirmada</em></li>
    {% endfor %}
    
    {% if canedit %}
        <li>Añadir un usuario:<br><input id="userSearch" type="text" name="targetUser" autocomplete="off"> <i id="destinationLoading" class="icon-cog icon-spin hidden"></i>
            <ul id="userResults" class="dropdown-menu span3" style="position:static;float:none;" role="menu" aria-labelledby="dropdownMenu"></ul>
        </li>
    {% endif %}
    
    </ul>
    
    {% if canedit %}<p style="text-align:right"><button id="updateBtn" class="btn" type="submit"><i id="updateBtnLoading"></i> Actualizar</button></p>{% endif %}
    
    </div>
    
    {% if canedit %}</form>{% endif %}
    
    {% include 'ColectaItemBundle:Default:related.html.twig' with { 'items' : item.related } %}
    
    {% include 'ColectaItemBundle:Default:itemactions.html.twig' with { item: item } only %}
    
    {% include 'ColectaItemBundle:Comment:comments.html.twig' with { 'comments': item.comments, 'item': item, 'collapse': 18 } only %}
    
</div>
{% endblock %}